/**
 * story|ftw - v0.1.0 - 2015-02-28 | http://storyftw.com | Copyright (c) 2015; | Licensed GPLv2+
 */
window.StoryFTW=window.StoryFTW||{},window.StoryFTW.Utils=function(t,e,n,r){"use strict";function s(){var t={},e=function(e,n,s){"boolean"==typeof n&&(s=n);var o=n?n.selector+" "+e:e;return(r===t[o]||s)&&(t[o]=n?n.find(e):jQuery(e)),t[o]};return e}var o=t.StoryFTW_l10n,i={};return i.log=function(){i.log.logHistory=i.log.logHistory||[],i.log.logHistory.push(arguments),t.console&&o.debug&&t.console.log(Array.prototype.slice.call(arguments))},i.cache=new s,i}(window,document,jQuery),window.StoryFTW=window.StoryFTW||{},function(t,e,n,r){"use strict";var s=t.StoryFTW_l10n,o=t.StoryFTW.Utils.cache;if(r.advancedToggle=function(){o(".advanced-toggle").children("small.toggle-label, .handlediv").click(function(){var t=n(this),e=t.parents(".advanced-toggle");e.hasClass("closed")?(e.removeClass("closed"),t.siblings(".inside").show()):(e.addClass("closed"),t.siblings(".inside").hide())})},s.storyID){var i="associated_story_id="+s.storyID;n.fn.addStoryID=function(){return this.each(function(){var t=n(this),e=t.attr("href"),r=e.search(/\?/i)?e+"&"+i:e+"?"+i;t.attr("href",r)})}}}(window,document,jQuery,window.StoryFTW),function(t,e,n,r){"use strict";var s=t.StoryFTW_l10n,o=t.Backbone,i=t.StoryFTW.Utils.log,a=t.StoryFTW.Utils.cache;return r.Views={},r.Page=o.Model.extend({defaults:{ID:null,menu_order:null,title:null,permalink:null,edit_link:null,delete_link:null,status:null,excerpt:null}}),r.Pages=o.Collection.extend({model:r.Page,sort_key:"menu_order",sort_menu_order:"ASC",sort_title:"ASC",sort_status:"ASC",getbyID:function(t){return t=parseInt(t,10),this.find(function(e){return t===parseInt(e.get("ID"),10)})},comparator:function(t,e){return t=t.get(this.sort_key),e=e.get(this.sort_key),"ASC"===this["sort_"+this.sort_key]?t>e?1:e>t?-1:0:e>t?1:t>e?-1:0},search:function(t){if(!t)return this;var e=RegExp(t,"gi");return _(this.filter(function(t){return e.test(t.get("title"))||e.test(t.get("excerpt"))}))}}),r.Views.Table=o.View.extend({events:{"click [data-sortby]":"sortBy","onsearch #post-search-input":"render","search #post-search-input":"render","keyup #post-search-input":"search"},spinner:"",initialize:function(){this.listenTo(this.collection,"change",this.changeHandler),this.listenTo(this.collection,"render reset sort",this.render),this.$list=this.$el.find("#the-list"),this.$search=this.$("#post-search-input"),a("#major-publishing-actions").append('<input type="hidden" id="story-page-order" name="story-page-order" value="" />'),this.render();var t=this;a("#the-list").disableSelection().sortable({items:"> tr",cursor:"move",axis:"y",containment:"table.widefat",cancel:".inline-edit-row",distance:2,opacity:.8,tolerance:"pointer",start:this.startDrag,helper:this.dragHelper,stop:this.stopDrag,update:function(){t.updateAfterDrag(t)}})},search:function(t){13===t.which||27===t.which?this.$search.val(""):this.renderItems(this.collection.search(this.$search.val()))},sortBy:function(t){i("click",t),t.preventDefault();var e=n(t.currentTarget);this.collection.sort_key=e.data("sortby"),"ASC"===this.collection["sort_"+this.collection.sort_key]?(e.removeClass("desc").addClass("asc"),this.collection["sort_"+this.collection.sort_key]="DESC"):(e.removeClass("asc").addClass("desc"),this.collection["sort_"+this.collection.sort_key]="ASC"),this.collection.sort()},changeHandler:function(t){i("modelChanged",t.changed),t.trigger("modelChanged")},startDrag:function(t,e){e.placeholder.height(e.item.height())},dragHelper:function(t,e){for(var r=e.children(),s=0;r.length>s;s++){var o=n(r[s]);o.width(o.width())}return e},stopDrag:function(t,e){e.item.children().css("width","")},updateAfterDrag:function(t){var e=[],r=t.collection;a("#the-list").find("tr.iedit").each(function(t){var s=n(this).data("pageid");e.push(s);var o=r.getbyID(s);o.set("menu_order",t)}),a("#story-page-order").val(e.join(","))},render:function(){this.renderItems(this.collection)},renderItems:function(t){var n,s=e.createDocumentFragment();t.each(function(t,e){n=e;var o=new r.Views.Row({model:t});s.appendChild(o.render().el)}),i("countcount",n),n=isNaN(n)?0:parseInt(n+1,10),a(".displaying-num span").text(n),this.$list.html(s),this.updateAfterDrag(this)}}),r.Views.Row=o.View.extend({tagName:"tr",events:{"click .submitdelete":"submitDelete","click .untrash a":"submitRestore"},template:wp.template("rowTemplate"),id:function(){return"post-"+this.model.get("ID")},className:function(){var t=0===this.model.get("menu_order")%2?"alternate":"";return"post-"+this.model.get("ID")+" type-storyftw_story_pages status-publish hentry "+t+" iedit author-self level-0 status-"+this.model.get("status")},attributes:function(){return{"data-pageid":this.model.get("ID")}},initialize:function(){this.restoreStatus=this.model.get("status"),this.listenTo(this.model,"modelChanged",this.render),this.listenTo(this.model,"render",this.render)},render:function(){var t="function"==typeof this.className?this.className():this.className,e=this.model.toJSON();return e.toggle="trash"===e.status?"delete":"trash",this.$el.html(this.template(e)).attr("class",t),this},submitDelete:function(t){t.preventDefault();var e=this,r=n(t.currentTarget).attr("href");this.asyncSubmit(r,function(t){t.hasClass("updated")&&(r.indexOf("action=delete")>-1?e.removeModel():e.model.set("status","trash"))})},submitRestore:function(t){t.preventDefault();var e=this;this.asyncSubmit(n(t.currentTarget).attr("href"),function(t){t.hasClass("updated")&&e.model.set("status",e.restoreStatus)})},asyncSubmit:function(t,r){var s=this;s.$(".spinner").show(),n.ajax({url:t,type:"GET",dataType:"html",cache:!1}).done(function(t){s.$(".spinner").hide();var o=n("<div>").append(n.parseHTML(t,e,!0)),a=o.find("#wpbody-content .wrap #message");i("text",a.text()),i("class",a.attr("class")),"function"==typeof r&&r(a)})},removeModel:function(){var t=this,e=t.model.collection;t.model.destroy({success:function(){t.$el.fadeOut(300,function(){t.$el.remove(),e.trigger("render")})}})}}),r.overridePostSearchInput=function(){setTimeout(function(){t.cmb2_post_search&&(t.cmb2_post_search.handleSelected=function(e){var r=this,s=this.$checked.length?this.$checked.last().data("permalink"):!1;return s?(r.$idInput.val(s),r.close(),undefined):(n.ajax(t.ajaxurl,{type:"POST",dataType:"json",data:{action:"storyftw_get_permalink",post_id:e}}).done(function(t){i("response",t),t.success&&r.$idInput.val(t.data),r.close()}).fail(function(){r.close()}),undefined)})},200)},r.resetPickerChangeCB=function(){var t=a("#_storyftw_fallback_bg_color").data("wpWpColorPicker");t.options&&(t.options.change=function(t,e){var r=(""+e.color).trim(),s=!1,o={};a(".cmb2-id--storyftw-palettes").find('#_storyftw_palettes_repeat input[type="text"].cmb2-colorpicker').each(function(){var t=n(this).iris("color");r===t&&(s=!0),t||o.length||(o=n(this))}),!s&&o.length&&(o.iris("color",r).val(r),a(".cmb-add-row-button",a(".cmb2-id--storyftw-palettes")).trigger("click"))})},r.init=function(){i(s),i(a),i("l10n.pages",s.pages);var t=_.toArray(s.pages);t.length&&(r.collection=new r.Views.Table({collection:new r.Pages(t),el:".story-pages-wrap"})),setTimeout(r.resetPickerChangeCB,500),r.advancedToggle(),r.overridePostSearchInput()},n(e).ready(r.init),r}(window,document,jQuery,window.StoryFTW);